@{
    ViewData["Title"] = "Поиск аниме";
}

<h1>@ViewData["Title"]</h1>
<br/>
<div class="container">
    <div class="row">
        <div class="col-2">
            <label class="col-form-label">Название аниме</label>
        </div>
        <div class="col-8">
            <input class="form-control" id="search-query" />
        </div>
        <div class="col-2">
            <button class="btn btn-primary search">Поиск</button>
        </div>
    </div>
    <div class="row">
        <div class="col-2">
            <label class="col-form-label">Провайдеры</label>
        </div>
        <div class="providers col-10">
        </div>
    </div>
</div>

<div class="container anime-result">
</div>

<script>
    var providers = [];
    var response_test = [];

    function GetProviders() {
        $.get('/api2', null, function (response, code) {
            providers = response.channels;
            FillSearchPage();
        });
    }

    function FillSearchPage() {
        var providersDiv = $('.providers');
        
        for (var providerIterator in providers) {
            var provider = providers[providerIterator];
            let html = '<label class="checkbox provider-checkbox"><input type="checkbox" value="' + providerIterator + '">' + provider.title + '</label>';
            providersDiv.append(html);
        }
    }

    function SearchAnime() {
        $('.provider-checkbox > input:checked').each(function (element) {
            $('.anime-result').html('');
            var provider = providers[$(this).val()];
            $.get(provider.playlist_url, { search : $('#search-query').val() }, function (response, status) {
                response_test.push(response);
                for (var channelIterator in response.channels) {
                    let channel = response.channels[channelIterator];
                    let html = '\
<div class="container anime-result-element"> \
  <div class="row"> \
    <div class="col-12"> \
      <img src="' + channel.logo_30x30 + '" class="rounded center poster" alt="' + channel.title + '"> \
    </div> \
  </div> \
  <div class="row"> \
    <div class="col-12"> \
      <label class="poster-label">' + channel.title + '</label> \
    </div> \
  </div> \
</div>';
                    $('.anime-result').append(html);
                }
            });
        });
    }
    
    $(function () {
        GetProviders();
        $('.search').click(function () { SearchAnime(); });
        $('#search-query').keyup(function (event) {
            if (event.keyCode === 13) {
                $('.search').click();
            }
        });
    });
</script>

<style>
    .provider-checkbox {
        padding: 9px 10px;
    }
    .anime-result {
        display: grid;
        grid-template-columns: 33% 33% 33%;
        grid-gap: 10px;
    }
    .anime-result-element {
        padding: 20px;
    }
    .poster {
        height: 400px;
        width: auto;
        margin: 0 auto;
        display: block;
    }
    .poster-label {
        font-size: 15px;
        color: black;
        text-align: center;
        width: 80%;
        margin-left: 10%;
        font-weight: 700;
        margin-top: -50px;
        background-color: rgb(255, 255, 255, 0.7);
    }
</style>